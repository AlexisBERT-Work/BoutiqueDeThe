<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boutique de Thés - Gestion des Produits</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
<div class="container">

    <header style="text-align: center; margin-bottom: 25px;">
        <h1>Boutique de Thés</h1>
        <p class="subtitle">Gestion complète de votre collection de thés</p>
    </header>

    <div th:if="${message}" class="alert alert-success" th:text="${message}"></div>
    <div th:if="${erreur}" class="alert alert-error" th:text="${erreur}"></div>

    <div class="toolbar" style="margin-bottom: 25px; align-items: flex-start; flex-wrap: wrap; gap: 15px;">

        <div class="search-filter" style="flex: 2; min-width: 400px;">
            <form method="get" th:action="@{/}" style="display: flex; align-items: center; gap: 10px; width: 100%;">
                <input type="text" name="recherche" placeholder="Rechercher un thé..." th:value="${recherche}" style="flex: 1; max-width: 250px;">

                <select name="typeThe" style="width: auto; min-width: 150px;">
                    <option value="">Tous les types</option>
                    <option th:each="type : ${typesThe}"
                            th:value="${type}"
                            th:text="${type}"
                            th:selected="${type == typeTheFiltre}">
                    </option>
                </select>

                <button type="submit" class="btn btn-primary" style="white-space: nowrap;">Rechercher</button>
            </form>
        </div>

        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <a th:href="@{/nouveau}" class="btn btn-success">Ajouter un thé</a>
            <a th:href="@{/exporter-csv(recherche=${recherche}, typeThe=${typeTheFiltre})}" class="btn btn-primary">
                Exporter CSV
            </a>
        </div>
    </div>

    <div style="overflow-x: auto; border-radius: 8px; border: 1px solid #3a3a3a;">
        <table style="width: 100%; border-collapse: collapse; min-width: 900px;">
            <thead style="background-color: #2c2c2c; color: #f5f5f5;">
            <tr>
                <th>ID</th>
                <th class="sortable" onclick="trierPar('nom')">Nom</th>
                <th>Type</th>
                <th>Origine</th>
                <th class="sortable" onclick="trierPar('prix')">Prix (EUR)</th>
                <th class="sortable" onclick="trierPar('quantite')">Stock</th>
                <th>Description</th>
                <th>Date Réception</th>
                <th style="text-align: center;">Actions</th>
            </tr>
            </thead>
            <tbody>
            <tr th:if="${#lists.isEmpty(produits)}">
                <td colspan="9" style="text-align: center; padding: 40px; color: #b0b0b0;">
                    Aucun produit trouvé.
                </td>
            </tr>
            <tr th:each="produit : ${produits}">
                <td th:text="${produit.id}"></td>
                <td><strong th:text="${produit.nom}"></strong></td>
                <td>
                    <span class="badge"
                          th:classappend="${produit.typeThe == 'Vert' ? 'badge-vert' : (produit.typeThe == 'Noir' ? 'badge-noir' : (produit.typeThe == 'Oolong' ? 'badge-oolong' : (produit.typeThe == 'Blanc' ? 'badge-blanc' : 'badge-puerh')))}"
                          th:text="${produit.typeThe}">
                    </span>
                </td>
                <td th:text="${produit.origine}"></td>
                <td><strong th:text="${#numbers.formatDecimal(produit.prix, 1, 2)} + ' EUR'"></strong></td>
                <td>
                    <span th:classappend="${produit.quantiteStock < 10 ? 'stock-low' : (produit.quantiteStock < 30 ? 'stock-medium' : 'stock-high')}"
                          th:text="${produit.quantiteStock}">
                    </span>
                </td>
                <td>
                    <span th:text="${#strings.abbreviate(produit.description, 50)}" th:title="${produit.description}"></span>
                </td>
                <td th:text="${#temporals.format(produit.dateReception, 'dd/MM/yyyy')}"></td>
                <td>
                    <div class="actions" style="justify-content: center; gap: 5px;">
                        <a th:href="@{/modifier/{id}(id=${produit.id})}" class="btn btn-warning">Modifier</a>
                        <a th:href="@{/supprimer/{id}(id=${produit.id})}"
                           class="btn btn-danger"
                           th:onclick="return confirmerSuppression([[${produit.nom}]])">Supprimer</a>
                    </div>
                </td>
            </tr>
            </tbody>
        </table>
    </div>

</div>

<script th:inline="javascript">
    function confirmerSuppression(nom) {
        return confirm('Etes-vous sur de vouloir supprimer le thé "' + nom + '" ?');
    }

    function trierPar(colonne) {
        const urlParams = new URLSearchParams(window.location.search);
        urlParams.set('sort', colonne);
        urlParams.set('page', '0');
        window.location.search = urlParams.toString();
    }
</script>
</body>
</html>